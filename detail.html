<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detail Siswa — Portal Wali Kelas VII-H</title>

  <!-- Bootstrap (untuk layout & tabs) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Optional: gunakan style.css utama (jika ada di root guruwalibayu) -->
  <link rel="stylesheet" href="../style.css">

  <style>
    /* tambahan styling khusus detail */
    .profile-card{max-width:980px;margin:18px auto;padding:18px;border-radius:12px;background:#fff;box-shadow:0 12px 30px rgba(6,32,58,0.04)}
    .avatar{width:120px;height:120px;border-radius:12px;object-fit:cover;border:1px solid rgba(6,32,58,0.06)}
    .muted{color:#65748b}
    .tab-content{margin-top:14px}
    .wa-btn{color:#fff;background:#25D366;border:none;border-radius:6px;padding:8px 10px}
    .small-muted{font-size:13px;color:#8895a8}
    .note-box{background: #f7fbff;padding:12px;border-radius:8px;border:1px solid rgba(10,30,60,0.03)}
  </style>
</head>
<body style="background:#f6fbff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;">

  <div class="container">
    <div style="max-width:1100px;margin:18px auto;">
      <a href="../datasiswa.html" class="btn btn-link"><i class="bi bi-arrow-left"></i> Kembali ke Daftar Siswa</a>
    </div>

    <div class="profile-card">
      <div class="row g-3">
        <div class="col-md-3 text-center">
          <img id="avatarImg" class="avatar" src="../assets/img/siswa/default.jpg" alt="Foto Siswa">
        </div>
        <div class="col-md-6">
          <h3 id="p_nama">Nama Siswa</h3>
          <div class="small-muted" id="p_meta">Kelas • JK</div>
          <p style="margin-top:10px;" id="p_target" class="note-box"></p>
          <p style="margin-top:10px;" class="small-muted">Catatan Wali: <span id="p_catatan">-</span></p>
        </div>
        <div class="col-md-3 text-end">
          <div class="small-muted">Kontak Orang Tua</div>
          <div style="margin-top:8px"><strong id="p_ortu">-</strong></div>
          <div class="mt-2" id="btn_wa_container"></div>
          <div class="small-muted mt-3">NISN: <span id="p_nisn">-</span></div>
        </div>
      </div>

      <!-- tabs -->
      <ul class="nav nav-tabs mt-4" id="detailTabs" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="tab-profil" data-bs-toggle="tab" data-bs-target="#tabProfil" type="button" role="tab">Profil</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-curhat" data-bs-toggle="tab" data-bs-target="#tabCurhat" type="button" role="tab">Curhat</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-pembinaan" data-bs-toggle="tab" data-bs-target="#tabPembinaan" type="button" role="tab">Pembinaan</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-ortu" data-bs-toggle="tab" data-bs-target="#tabOrtu" type="button" role="tab">Orang Tua</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="tab-rekap" data-bs-toggle="tab" data-bs-target="#tabRekap" type="button" role="tab">Rekap</button></li>
      </ul>

      <div class="tab-content">
        <!-- PROFIL -->
        <div class="tab-pane fade show active" id="tabProfil" role="tabpanel">
          <div class="mt-3">
            <h5>Profil Singkat</h5>
            <table class="table table-sm">
              <tbody>
                <tr><th style="width:160px">Nama</th><td id="t_nama">-</td></tr>
                <tr><th>Jenis Kelamin</th><td id="t_jk">-</td></tr>
                <tr><th>Kelas</th><td id="t_kelas">-</td></tr>
                <tr><th>NISN</th><td id="t_nisn">-</td></tr>
                <tr><th>Orang Tua</th><td id="t_ortu">-</td></tr>
                <tr><th>No. WA Ortu</th><td id="t_nowa">-</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- CURHAT -->
        <div class="tab-pane fade" id="tabCurhat" role="tabpanel">
          <div class="mt-3">
            <h5>Tulis Curhat (untuk wali simpan)</h5>
            <div class="mb-2"><select id="curhat_from" class="form-select"></select></div>
            <div class="mb-2"><textarea id="curhat_text" class="form-control" rows="4" placeholder="Tuliskan curhat atau catatan emosi/keluhan..."></textarea></div>
            <div class="d-flex gap-2">
              <button id="saveCurhatBtn" class="btn btn-primary">Simpan Curhat</button>
              <button id="clearCurhatBtn" class="btn btn-outline-secondary">Hapus Semua Curhat</button>
            </div>
            <hr>
            <h6>Riwayat Curhat</h6>
            <div id="curhat_list" class="mt-2"></div>
          </div>
        </div>

        <!-- PEMBINAAN -->
        <div class="tab-pane fade" id="tabPembinaan" role="tabpanel">
          <div class="mt-3">
            <h5>Tambah Pembinaan</h5>
            <div class="mb-2"><select id="pem_from" class="form-select"></select></div>
            <div class="mb-2"><textarea id="pem_text" class="form-control" rows="4" placeholder="Rencana atau hasil pembinaan..."></textarea></div>
            <div class="d-flex gap-2">
              <button id="savePemBtn" class="btn btn-primary">Simpan Pembinaan</button>
              <button id="clearPemBtn" class="btn btn-outline-secondary">Hapus Semua Pembinaan</button>
            </div>
            <hr>
            <h6>Riwayat Pembinaan</h6>
            <div id="pem_list" class="mt-2"></div>
          </div>
        </div>

        <!-- ORTU -->
        <div class="tab-pane fade" id="tabOrtu" role="tabpanel">
          <div class="mt-3">
            <h5>Kirim Pesan ke Orang Tua</h5>
            <div class="mb-2 small-muted">Pesan ini bisa disalin atau dikirim via WhatsApp (klik “Chat via WA”).</div>
            <div class="mb-2"><textarea id="msg_ortu" class="form-control" rows="4" placeholder="Tulis pesan untuk orang tua..."></textarea></div>
            <div class="d-flex gap-2">
              <button id="copyMsgBtn" class="btn btn-outline-primary">Salin Pesan</button>
              <button id="sendWaBtn" class="btn wa-btn"> <i class="bi bi-whatsapp me-1"></i> Chat via WA</button>
            </div>
            <hr>
            <h6>Riwayat Komunikasi</h6>
            <div id="kom_list" class="mt-2"></div>
          </div>
        </div>

        <!-- REKAP -->
        <div class="tab-pane fade" id="tabRekap" role="tabpanel">
          <div class="mt-3">
            <h5>Rekap Semua Catatan</h5>
            <div class="mb-2 small-muted">Export rekap ke CSV bila perlu.</div>
            <div class="d-flex gap-2 mb-2">
              <button id="expAllBtn" class="btn btn-outline-primary">Export Semua (CSV)</button>
            </div>
            <div id="rekap_content" class="mt-2"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- data.js (harus di root guruwalibayu) -->
  <script src="../data.js"></script>

  <script>
    /* detail.html script
       - baca param ?id=NO
       - ambil data dari dataSiswa (data.js)
       - tampilkan profil + tab handlers
       - simpan Curhat/Pembinaan/Komunikasi ke localStorage per siswa
    */

    // default template values (dari input Bayu)
    const DEFAULT_TARGET = "Menjadi pribadi yang disiplin dan bertanggung jawab";
    const DEFAULT_CATATAN = "Siswa perlu meningkatkan kerapian dan etika";
    const DEFAULT_HP = "0895332xxxx";

    // localStorage keys base
    const LSBASE = 'gw_v1_'; // we'll use: gw_v1_curhat_{no}, gw_v1_pem_{no}, gw_v1_kom_{no}

    // helper: get param id
    function getParam(name){
      const url = new URL(location.href);
      return url.searchParams.get(name);
    }

    // WA link helper (local 08... -> wa.me/62...)
    function waLinkFromLocal(nowa){
      if(!nowa) return null;
      let s = String(nowa).trim().replace(/[^0-9+]/g,'');
      if(s.startsWith('+')) return 'https://wa.me/' + s.slice(1);
      if(s.startsWith('0')) return 'https://wa.me/62' + s.slice(1);
      if(s.startsWith('62')) return 'https://wa.me/' + s;
      return 'https://wa.me/' + s;
    }

    // get id (no)
    const id = Number(getParam('id') || getParam('no') || 0);

    // find student
    const student = (window.dataSiswa || []).find(s => Number(s.no) === Number(id));

    // if not found -> simple message and link back
    if(!student){
      document.body.innerHTML = '<div style="padding:28px"><h3>Data siswa tidak ditemukan</h3><p><a href="../datasiswa.html">Kembali ke Daftar Siswa</a></p></div>';
      throw new Error('student not found');
    }

    // use defaults if empty
    if(!student.target) student.target = DEFAULT_TARGET;
    if(!student.catatan) student.catatan = DEFAULT_CATATAN;
    if(!student.nowa) student.nowa = DEFAULT_HP;

    // avatar path: ../assets/img/siswa/{no}.jpg  (you must upload file manually)
    const avatarPath = `../assets/img/siswa/${student.no}.jpg`;
    // attempt to load image — if 404 browser will still show alt, so we also set fallback to default
    const avatarImg = document.getElementById('avatarImg');
    avatarImg.src = avatarPath;
    avatarImg.onerror = () => { avatarImg.src = '../assets/img/siswa/default.jpg'; };

    // fill header/profile
    document.getElementById('p_nama').textContent = student.nama;
    document.getElementById('p_meta').textContent = `${student.kelas} • ${student.jk === 'L' ? 'Laki-laki' : 'Perempuan'}`;
    document.getElementById('p_target').textContent = student.target || '-';
    document.getElementById('p_catatan').textContent = student.catatan || '-';
    document.getElementById('p_ortu').textContent = student.ortu || '-';
    document.getElementById('p_nisn').textContent = student.nisn || '-';

    // profile table
    document.getElementById('t_nama').textContent = student.nama;
    document.getElementById('t_jk').textContent = (student.jk === 'L' ? 'Laki-laki' : 'Perempuan');
    document.getElementById('t_kelas').textContent = student.kelas;
    document.getElementById('t_nisn').textContent = student.nisn || '-';
    document.getElementById('t_ortu').textContent = student.ortu || '-';
    document.getElementById('t_nowa').textContent = student.nowa || '-';

    // WA button in header area
    const btnWaContainer = document.getElementById('btn_wa_container');
    if(student.nowa && student.nowa.trim()){
      const a = document.createElement('a');
      a.className = 'btn wa-btn';
      a.href = waLinkFromLocal(student.nowa);
      a.target = '_blank';
      a.rel = 'noopener';
      a.innerHTML = '<i class="bi bi-whatsapp me-1"></i> Chat Ortu';
      btnWaContainer.appendChild(a);
    } else {
      btnWaContainer.innerHTML = '<button class="btn wa-btn disabled">WA belum tersedia</button>';
    }

    /* ---------- CURHAT ---------- */
    const curhatKey = LSBASE + 'curhat_' + student.no;
    const pemKey = LSBASE + 'pem_' + student.no;
    const komKey = LSBASE + 'kom_' + student.no;

    function loadArray(key){ return JSON.parse(localStorage.getItem(key) || '[]'); }
    function saveArray(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

    // populate select (penulis) with options: Wali / Guru / Orang Tua
    const curhatFrom = document.getElementById('curhat_from');
    const pemFrom = document.getElementById('pem_from');
    ['Wali Kelas','Guru Mata Pelajaran','Orang Tua','Lainnya'].forEach(txt => {
      const o = document.createElement('option'); o.value = txt; o.textContent = txt;
      curhatFrom.appendChild(o);
      pemFrom.appendChild(o.cloneNode(true));
    });

    // render curhat list
    function renderCurhat(){
      const list = loadArray(curhatKey);
      const ctn = document.getElementById('curhat_list');
      if(!list.length) { ctn.innerHTML = '<div class="small-muted">Belum ada curhat.</div>'; return; }
      ctn.innerHTML = '';
      list.forEach((c,i) => {
        const el = document.createElement('div');
        el.className = 'mb-2';
        el.innerHTML = `<div class="note-box"><div class="small-muted">${c.who} • ${c.date}</div><div style="margin-top:6px">${escapeHtml(c.text)}</div>
          <div class="text-end mt-2"><button class="btn btn-sm btn-outline-danger" onclick="deleteCurhat(${i})">Hapus</button></div></div>`;
        ctn.appendChild(el);
      });
    }
    function saveCurhat(){
      const text = document.getElementById('curhat_text').value.trim();
      const who = document.getElementById('curhat_from').value;
      if(!text){ alert('Isi teks curhat'); return; }
      const arr = loadArray(curhatKey);
      arr.unshift({who, text, date: new Date().toLocaleString()});
      saveArray(curhatKey, arr); document.getElementById('curhat_text').value = ''; renderCurhat(); toast('Curhat tersimpan');
    }
    function deleteCurhat(i){ if(!confirm('Hapus curhat?')) return; const arr = loadArray(curhatKey); arr.splice(i,1); saveArray(curhatKey, arr); renderCurhat(); }

    document.getElementById('saveCurhatBtn').addEventListener('click', saveCurhat);
    document.getElementById('clearCurhatBtn').addEventListener('click', ()=>{ if(!confirm('Hapus seluruh curhat?')) return; saveArray(curhatKey, []); renderCurhat(); });

    // initial render
    renderCurhat();

    /* ---------- PEMBINAAN ---------- */
    function renderPem(){
      const list = loadArray(pemKey);
      const ctn = document.getElementById('pem_list');
      if(!list.length) { ctn.innerHTML = '<div class="small-muted">Belum ada pembinaan.</div>'; return; }
      ctn.innerHTML = '';
      list.forEach((p,i) => {
        const el = document.createElement('div'); el.className='mb-2';
        el.innerHTML = `<div class="note-box"><div class="small-muted">${p.who} • ${p.date}</div><div style="margin-top:6px">${escapeHtml(p.note)}</div>
          <div class="text-end mt-2"><button class="btn btn-sm btn-outline-danger" onclick="deletePem(${i})">Hapus</button></div></div>`;
        ctn.appendChild(el);
      });
    }
    function savePem(){
      const note = document.getElementById('pem_text').value.trim();
      const who = document.getElementById('pem_from').value;
      if(!note){ alert('Isi catatan pembinaan'); return; }
      const arr = loadArray(pemKey); arr.unshift({who, note, date: new Date().toLocaleString()}); saveArray(pemKey, arr);
      document.getElementById('pem_text').value = ''; renderPem(); toast('Pembinaan tersimpan');
    }
    function deletePem(i){ if(!confirm('Hapus pembinaan?')) return; const arr = loadArray(pemKey); arr.splice(i,1); saveArray(pemKey, arr); renderPem(); }
    document.getElementById('savePemBtn').addEventListener('click', savePem);
    document.getElementById('clearPemBtn').addEventListener('click', ()=>{ if(!confirm('Hapus seluruh pembinaan?')) return; saveArray(pemKey, []); renderPem(); });
    renderPem();

    /* ---------- KOMUNIKASI ORTU ---------- */
    function renderKom(){
      const list = loadArray(komKey);
      const ctn = document.getElementById('kom_list');
      if(!list.length) { ctn.innerHTML = '<div class="small-muted">Belum ada komunikasi.</div>'; return; }
      ctn.innerHTML = '';
      list.forEach((k,i) => {
        const el = document.createElement('div'); el.className='mb-2';
        el.innerHTML = `<div class="note-box"><div class="small-muted">${k.who} • ${k.date}</div><div style="margin-top:6px">${escapeHtml(k.msg)}</div>
          <div class="text-end mt-2"><button class="btn btn-sm btn-outline-danger" onclick="deleteKom(${i})">Hapus</button></div></div>`;
        ctn.appendChild(el);
      });
    }
    function saveKom(who, msg){
      const arr = loadArray(komKey); arr.unshift({who, msg, date: new Date().toLocaleString()}); saveArray(komKey, arr); renderKom(); toast('Pesan disimpan di riwayat');
    }
    // copy & send
    document.getElementById('copyMsgBtn').addEventListener('click', ()=>{
      const t = document.getElementById('msg_ortu').value.trim();
      if(!t){ alert('Tulis pesan dulu'); return; }
      navigator.clipboard?.writeText(t).then(()=> toast('Pesan disalin ke clipboard'));
      saveKom('Wali Kelas', t);
    });
    document.getElementById('sendWaBtn').addEventListener('click', ()=>{
      const t = document.getElementById('msg_ortu').value.trim();
      if(!t){ alert('Tulis pesan dulu'); return; }
      if(!student.nowa || !student.nowa.trim()){ alert('Nomor WA orang tua tidak tersedia'); return; }
      const url = waLinkFromLocal(student.nowa) + '?text=' + encodeURIComponent(t);
      saveKom('Wali Kelas', t);
      window.open(url, '_blank');
    });
    function deleteKom(i){ if(!confirm('Hapus komunikasi?')) return; const arr = loadArray(komKey); arr.splice(i,1); saveArray(komKey, arr); renderKom(); }
    renderKom();

    /* ---------- REKAP ---------- */
    function renderRekap(){
      const cur = loadArray(curhatKey);
      const pem = loadArray(pemKey);
      const kom = loadArray(komKey);
      const ctn = document.getElementById('rekap_content');
      ctn.innerHTML = `<div class="mb-2 small-muted">Total Curhat: ${cur.length} • Total Pembinaan: ${pem.length} • Total Komunikasi: ${kom.length}</div>`;
      // show lists
      const wrap = document.createElement('div');
      if(cur.length){
        const h = document.createElement('h6'); h.textContent='Curhat'; wrap.appendChild(h);
        cur.forEach(c=> wrap.appendChild(renderSmallRow('Curhat', c)));
      }
      if(pem.length){
        const h2 = document.createElement('h6'); h2.textContent='Pembinaan'; wrap.appendChild(h2);
        pem.forEach(p=> wrap.appendChild(renderSmallRow('Pembinaan', p)));
      }
      if(kom.length){
        const h3 = document.createElement('h6'); h3.textContent='Komunikasi'; wrap.appendChild(h3);
        kom.forEach(k=> wrap.appendChild(renderSmallRow('Komunikasi', k)));
      }
      ctn.appendChild(wrap);
    }
    function renderSmallRow(type, obj){
      const el = document.createElement('div'); el.className='note-box mb-2';
      el.innerHTML = `<div class="small-muted">${type} • ${obj.date}</div><div style="margin-top:6px">${escapeHtml(obj.text || obj.note || obj.msg)}</div>`;
      return el;
    }
    document.getElementById('expAllBtn').addEventListener('click', ()=>{
      // build csv from curhat/pem/kom
      const rows = [['Tipe','Tanggal','Penulis','Isi']];
      loadArray(curhatKey).forEach(c => rows.push(['Curhat', c.date, c.who, c.text]));
      loadArray(pemKey).forEach(p => rows.push(['Pembinaan', p.date, p.who, p.note]));
      loadArray(komKey).forEach(k => rows.push(['Komunikasi', k.date, k.who, k.msg]));
      const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `rekap_siswa_${student.no}_${student.nama.replace(/\s+/g,'_')}.csv`; a.click(); URL.revokeObjectURL(url);
    });

    /* ---------- helpers ---------- */
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function toast(msg){ const d = document.createElement('div'); d.textContent = msg; Object.assign(d.style,{position:'fixed',right:'18px',bottom:'18px',padding:'8px 12px',background:'#06203a',color:'#fff',borderRadius:'8px',zIndex:120}); document.body.appendChild(d); setTimeout(()=> d.style.opacity=0,1600); setTimeout(()=> d.remove(),2200); }
  </script>
</body>
</html>
